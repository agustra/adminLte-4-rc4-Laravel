import{ModernTable as D}from"https://cdn.jsdelivr.net/npm/modern-table-js@1.0.6/core/ModernTable.js";import{D as T}from"./delete-D9NIfc68.js";import{f as x,c as w,a as A,b as I,d as M}from"./formatDate-DZoGuVE6.js";import{h as E}from"./handlePermissionButtons-TMegtcb-.js";import{A as y}from"./ActionButton-4FF2Dtnd.js";import{f as R,D as F}from"./DateRangePicker-pIMxf9xW.js";import{s as i}from"./modalHandler-l1VpEcIP.js";import{f as L}from"./fetchAxios-BCs8Bycy.js";import{I as P}from"./InitTomSelect-CEYaOZ7F.js";import _ from"./axiosClient-DXQnQ5LA.js";import{i as p,f as k}from"./permissionsPopup-33kLpmI4.js";import"./badgeUpdater-D7fo0NmU.js";import"./_commonjsHelpers-CqkleIqs.js";import"./preload-helper-BfFHrpNk.js";function f(t){let e;if(t&&t.target?e=t.target.querySelector("#permissions"):e=t,!e||e.tomselectInstance)return null;const o=e.dataset.selected?e.dataset.selected.split(",").filter(r=>r.trim()):[],n=new P(e,{urlGet:"/api/permissions/json?grouped=true",urlByIds:"/api/permissions/by-ids",urlStore:"/api/permissions",create:!0,createSingle:!0,modalId:"createTomselectModal",multiple:!0,createUrl:"/admin/permissions/create",valueField:"id",labelField:"name",searchField:["name"],preSelectedValues:o,grouped:!0,modalOptions:{fieldMapping:{permission:"name"},buttonId:"btnActionTomSelect"}});return n.ts.on("change",function(){u(n.ts)}),n}function u(t){let e;if(t&&t.target){const s=t.target.querySelector("#permissions");e=s==null?void 0:s.tomselectInstance}else e=t;const o=e?e.getValue():[],n=document.getElementById("permission-badges");if(n){if(n.innerHTML="",o.length===0){const r=document.createElement("small");r.className="text-muted",r.textContent="(0 permissions)",n.appendChild(r);return}_.get(`/api/permissions/by-ids?ids=${o.join(",")}`).then(r=>{const s=r.data.data||[];n.innerHTML="",s.forEach(B=>{const d=document.createElement("span");d.className="badge bg-success me-1 mb-1",d.textContent=B.name,n.appendChild(d)});const a=document.createElement("small");a.className="text-muted ms-2",a.textContent=`(${s.length} permissions)`,n.appendChild(a)}).catch(r=>{console.error("Error fetching permission names:",r),o.forEach(s=>{const a=document.createElement("span");a.className="badge bg-secondary me-1 mb-1",a.textContent=`Permission ${s}`,n.appendChild(a)})})}}const b={month:null,year:null,start_date:null,end_date:null},l={tableId:"#table-roles",urlWeb:"/admin/roles",urlApi:"/api/roles",deleteMultipleUrl:"/api/roles/multiple/delete",tableName:"roles",exportColumns:["name","permissions"],createButtonText:"Add Roles",createButtonId:"btnTambah",bulkDeleteButtonId:"delete-selected-btn",dateRangeSelector:"#idFilterDateRange",dateRangeTextSelector:"#idFilterDateRange .date-range-text",actionButtonSelector:"#btnAction",formSelector:".FormAction",deleteButtonClass:".btn-delete",createButtonClass:".btnTambah",updateButtonClass:".buttonUpdate",showButtonClass:".buttonShow"};let m=!1,c={...b};const N=()=>m?Object.fromEntries(Object.entries(c).filter(([t,e])=>e!==null)):{},g=t=>{m=!0,c={...c,...t,date:null}},h=()=>{m=!1,c={...b}},H=A({buttonId:l.bulkDeleteButtonId,countSelector:".selected-count",onSelectionChange:(t,{count:e,hasSelection:o})=>{console.log(`ℹ️ Selection changed: ${e} roles selected`)}}),$=M({deleteUrl:l.deleteMultipleUrl,itemName:"roles",onSuccess:(t,e)=>{console.log("✅ Bulk delete success:",t.length,"roles deleted")},onError:t=>{console.error("❌ Bulk delete failed:",t)}});function v(){return x(new Date),{...w({url:l.urlApi,beforeSend:e=>Object.assign(e,N()),onSuccess:e=>{var n;const o=(n=e==null?void 0:e.meta)==null?void 0:n.permissions;o&&E(o)},onError:(e,o,n)=>{console.error("Roles API Error:",{error:e,status:o,message:n})}}),columns:[{data:"DT_RowIndex",title:"No",orderable:!1,searchable:!1},{data:"name",title:"Name",orderable:!0},{data:"permissions",title:"Permissions",orderable:!0,searchable:!0,render:(e,o,n)=>{let r=(n==null?void 0:n.permissions)??[];return typeof r=="string"&&(r=r.split(",").map(s=>s.trim()).filter(s=>s)),k(r,n,"role")}},{data:"actions",title:"Action",className:"text-center",orderable:!1,searchable:!1,render:(e,o,n)=>y(n)}],buttons:I({tableName:l.tableName,exportColumns:l.exportColumns,bulkDeleteHandler:$,bulkDeleteButtonId:l.bulkDeleteButtonId,includeCreateButton:!0,createButtonId:l.createButtonId,createButtonText:l.createButtonText,createHandler:()=>{i(`${l.urlWeb}create`,"create")}}),pageLength:10,lengthMenu:[5,10,25,50],order:[[0,"desc"]],ordering:!0,searching:!0,columnSearch:!0,paging:!0,select:!0,responsive:!0,theme:"auto",keyboard:!1,accessibility:!0,stateSave:!0,stateDuration:3600,onSelectionChange:H,onError:e=>console.error("❌ Table error:",e)}}function U(t,e,o){t||e?g({month:t||null,year:e||null}):h(),o.reload()}function j(t,e){if(t){g({start_date:t.start,end_date:t.end});const o=document.querySelector(l.dateRangeTextSelector);o&&(o.textContent=t.formatted)}else h();e.reload()}function S(){const t=v(),e=new D(l.tableId,{...t,initComplete:(o,n)=>{console.log("✅ Data loaded:",o.length,"records")}});return R((o,n)=>{U(o,n,e)}),new F(l.dateRangeSelector,{buttonText:"Filter Tanggal",onDateSelect:o=>{j(o,e)}}),e}function C(t){T({buttonSelector:l.deleteButtonClass,deleteUrl:l.urlApi+"/",tableSelector:l.tableId,onDeleteSuccess:()=>{t.reload(),t.clearSelection()}}),document.body.addEventListener("click",e=>{const o=e.target.closest(l.updateButtonClass),n=e.target.closest(l.showButtonClass),r=e.target.matches(l.actionButtonSelector);if(e.target.closest(l.createButtonClass))e.preventDefault(),i(`${l.urlWeb}create`,"create");else if(o){e.preventDefault();const a=`${l.urlWeb}${o.dataset.id}/edit`;i(a,"edit")}else if(n){e.preventDefault();const a=`${l.urlWeb}${n.dataset.id}`;i(a,"show")}else if(r){e.preventDefault();const a=document.querySelector(l.formSelector);a&&L({url:a.action,method:a.method,data:new FormData(a)},"simpan",()=>t.reload())}})}document.addEventListener("DOMContentLoaded",()=>{const t=S();if(C(t),p(),!window.rolesModalListenerAttached){const e=function(o){o.target.id==="modalAction"&&(console.log("Roles modal shown!"),f(o),u(o))};document.addEventListener("shown.bs.modal",e),window.rolesModalListenerAttached=!0,window.rolesModalHandler=e}});function oe(){if(document.readyState!=="loading"){const t=S();if(C(t),p(),!window.rolesModalListenerAttached){const e=function(o){o.target.id==="modalAction"&&(console.log("Roles modal shown!"),f(o),u(o))};document.addEventListener("shown.bs.modal",e),window.rolesModalListenerAttached=!0,window.rolesModalHandler=e}}}export{oe as default};
