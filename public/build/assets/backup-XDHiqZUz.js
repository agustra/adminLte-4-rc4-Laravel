import{ModernTable as v}from"https://cdn.jsdelivr.net/npm/modern-table-js@1.0.6/core/ModernTable.js";import{D as y}from"./delete-QRht9yhg.js";import{a as D,c as C,b as L,g as x,d as _}from"./formatDate-Cz7pwXTf.js";import{f as $,D as E}from"./DateRangePicker-pIMxf9xW.js";import g from"./axiosClient-8LtfCK6A.js";import"./badgeUpdater-D1PKXa5-.js";import"./_commonjsHelpers-CqkleIqs.js";const A=x(),w={month:null,year:null,start_date:null,end_date:null,date:A},o={urlApi:"/api/backup",deleteMultipleUrl:"/api/backup/multiple/delete",countsUrl:"/api/backup/counts",tableName:"backups",exportColumns:["name","formatted_size","formatted_date"],itemName:"backups",pageLength:10,lengthMenu:[10,25,50,100],defaultOrder:[[3,"desc"]],dateRangeButtonText:"Filter Tanggal",showAllDataOnLoad:!0,apiErrorPrefix:"Backup API Error:",dataLoadedMessage:"‚úÖ Data loaded:",dateRangeSelector:"#idFilterDateRange",dateRangeTextSelector:"#idFilterDateRange .date-range-text",storageKey:"backup_active_tab"};let p=!1,f={...w},l=null,s=F(),i={};const R=()=>p?Object.fromEntries(Object.entries(f).filter(([e,t])=>t!==null)):{},h=e=>{p=!0,f={...f,...e,date:null}},B=()=>{p=!1,f={...w}};function F(){try{return localStorage.getItem(o.storageKey)||"local"}catch{return"local"}}function I(e){try{localStorage.setItem(o.storageKey,e)}catch(t){console.error("localStorage save error:",t)}}function b(){document.querySelectorAll(".backup-tab").forEach(n=>{n.classList.remove("active","btn-primary"),n.classList.add("btn-outline-primary")}),document.querySelectorAll(".tab-pane").forEach(n=>{n.classList.remove("show","active")});const e=document.querySelector(`[data-tab="${s}"]`),t=document.getElementById(`${s}-tab`);e&&(e.classList.remove("btn-outline-primary"),e.classList.add("active","btn-primary")),t&&t.classList.add("show","active")}function U(e,t,n){e||t?h({month:e||null,year:t||null}):B(),n.reload()}function M(e,t){if(e){h({start_date:e.start,end_date:e.end});const n=document.querySelector(o.dateRangeTextSelector);n&&(n.textContent=e.formatted)}else B();t.reload()}function k(e){if(i[e])return;const t=D({buttonId:`btnDeleteSelected_${e}`,countSelector:".selected-count",onSelectionChange:(a,{count:r,hasSelection:c})=>{console.log(`‚ÑπÔ∏è Selection changed: ${r} ${o.itemName} selected`)}}),n=_({deleteUrl:o.deleteMultipleUrl,itemName:`${e} ${o.itemName}`,onSuccess:(a,r)=>{console.log("‚úÖ Bulk delete success:",a.length,`${e} ${o.itemName} deleted`),m()},onError:a=>{console.error("‚ùå Bulk delete failed:",a)}}),d=C({url:`${o.urlApi}?type=${e}`,beforeSend:a=>Object.assign(a,R()),onSuccess:a=>{a.additional&&a.additional.length>0&&S(a.additional[0])},onError:(a,r,c)=>{console.error(o.apiErrorPrefix,{error:a,status:r,message:c})}});i[e]=new v(`#${e}Table`,{...d,columns:[{data:"DT_RowIndex",title:"No",orderable:!1,searchable:!1},{data:"name",title:"Nama File",render:(a,r,c)=>(e==="local"?'<i class="fas fa-server text-primary me-2"></i>':'<i class="fab fa-google-drive text-success me-2"></i>')+a},{data:"formatted_size",title:"Ukuran"},{data:"formatted_date",title:"Tanggal"},{data:"actions",title:"Aksi",orderable:!1,render:(a,r,c)=>`
                        <button class="btn btn-info btn-sm me-1 btn-download" data-id="${c.id}" title="Download">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-danger btn-sm btn-delete" data-id="${c.id}" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    `}],buttons:L({tableName:`${e}-${o.tableName}`,exportColumns:o.exportColumns,bulkDeleteHandler:n,bulkDeleteButtonId:`btnDeleteSelected_${e}`,includeCreateButton:!0,createButtonId:`btn-create-${e}`,createButtonText:e==="local"?'<i class="fas fa-server"></i> üíæ Backup Lokal':'<i class="fab fa-google-drive"></i> ‚òÅÔ∏è Backup Google Drive',createHandler:()=>createBackupForTab(e)}),pageLength:o.pageLength,lengthMenu:o.lengthMenu,order:o.defaultOrder,select:!0,responsive:!0,onSelectionChange:t,onError:a=>console.error("‚ùå Table error:",a),initComplete:(a,r)=>{console.log(o.dataLoadedMessage,a.length,"records"),document.querySelector(o.dateRangeSelector)&&($((c,u)=>{U(c,u,i[e])}),new E(o.dateRangeSelector,{buttonText:o.dateRangeButtonText,onDateSelect:c=>{M(c,i[e])}}))}}),setTimeout(()=>{y({buttonSelector:".btn-delete",deleteUrl:a=>`${o.urlApi}/${a}?type=${e}`,tableSelector:`#${e}Table`,onDeleteSuccess:()=>{l==null||l.reload(),m()}})},500)}function O(e){I(e),s=e,b(),i[e]||k(e),l=i[e],window.backupTable=l,l&&l.reload&&l.reload()}async function m(){try{const e=await g.get(o.countsUrl);S(e.data)}catch(e){console.error("Error loading counts:",e)}}function S(e){const t=document.getElementById("local-count"),n=document.getElementById("google-count");t&&e.local_count!==void 0&&(t.textContent=e.local_count),n&&e.google_count!==void 0&&(n.textContent=e.google_count)}window.createBackupForTab=async function(e){try{const t=e==="local",n=t?"üíæ Buat Backup Lokal":"‚òÅÔ∏è Buat Backup Google Drive",d=t?"Backup akan disimpan di server lokal":"Backup akan disimpan di Google Drive";if((await Swal.fire({title:n,text:d,icon:"question",showCancelButton:!0,confirmButtonText:t?'<i class="fas fa-server"></i> Buat Backup Lokal':'<i class="fab fa-google-drive"></i> Buat Backup Google Drive',cancelButtonText:"Batal",confirmButtonColor:t?"#0d6efd":"#198754"})).isConfirmed){Swal.fire({title:"Membuat Backup...",html:`Sedang membuat backup ${t?"lokal":"Google Drive"}`,allowOutsideClick:!1,didOpen:()=>{Swal.showLoading()}});const r=new FormData;r.append("save_to_local",t),r.append("save_to_google",!t);const u=(await g.post(o.urlApi,r)).data;if(u.status==="success")Swal.fire({icon:"success",title:"Backup Berhasil!",text:u.message,timer:3e3}),l&&l.reload(),m();else throw new Error(u.message||"Backup gagal")}}catch(t){console.error("Create backup error:",t),Swal.fire({icon:"error",title:"Backup Gagal!",text:t.message||"Terjadi kesalahan saat membuat backup"})}};window.downloadBackup=async function(e){try{const t=await g.get(`${o.urlApi}/${e}/download?type=${s}`,{responseType:"blob"}),n=new Blob([t.data]),d=window.URL.createObjectURL(n),a=document.createElement("a");a.href=d;const r=e.replace(/^(local_|google_)/,"");a.download=r,document.body.appendChild(a),a.click(),document.body.removeChild(a),window.URL.revokeObjectURL(d)}catch(t){console.error("Download error:",t),Swal.fire({icon:"error",title:"Download Gagal!",text:"Terjadi kesalahan saat mengunduh backup"})}};function T(){document.addEventListener("click",e=>{const t=e.target.closest("[data-tab]");if(t){const n=t.dataset.tab;O(n)}}),document.addEventListener("click",e=>{if(e.target.closest(".btn-download")){e.preventDefault();const t=e.target.closest(".btn-download").dataset.id;downloadBackup(t)}})}document.addEventListener("DOMContentLoaded",function(){b(),k(s),l=i[s],window.backupTable=l,T(),m()});function K(){console.log("üîÑ Backup module initialized successfully!"),document.readyState!=="loading"&&(b(),k(s),l=i[s],window.backupTable=l,T(),m())}export{K as default};
