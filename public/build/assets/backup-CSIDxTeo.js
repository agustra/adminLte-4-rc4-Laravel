import{ModernTable as y}from"https://cdn.jsdelivr.net/npm/modern-table-js@1.0.6/core/ModernTable.js";import{D as v}from"./delete-D9NIfc68.js";import{a as D,c as _,b as C,g as L,d as x}from"./formatDate-DZoGuVE6.js";import{f as $,D as E}from"./DateRangePicker-pIMxf9xW.js";import m from"./axiosClient-DXQnQ5LA.js";import"./badgeUpdater-D7fo0NmU.js";import"./_commonjsHelpers-CqkleIqs.js";const A=L(),h={month:null,year:null,start_date:null,end_date:null,date:A},o={urlApi:"/api/backup",deleteMultipleUrl:"/api/backup/multiple/delete",countsUrl:"/api/backup/counts",tableName:"backups",exportColumns:["name","formatted_size","formatted_date"],itemName:"backups",pageLength:10,lengthMenu:[10,25,50,100],defaultOrder:[[3,"desc"]],dateRangeButtonText:"Filter Tanggal",showAllDataOnLoad:!0,apiErrorPrefix:"Backup API Error:",dataLoadedMessage:"‚úÖ Data loaded:",dateRangeSelector:"#idFilterDateRange",dateRangeTextSelector:"#idFilterDateRange .date-range-text",storageKey:"backup_active_tab"};let b=!1,p={...h},n=null,i=F(),s={};const R=()=>b?Object.fromEntries(Object.entries(p).filter(([e,t])=>t!==null)):{},B=e=>{b=!0,p={...p,...e,date:null}},S=()=>{b=!1,p={...h}};function F(){try{return localStorage.getItem(o.storageKey)||"local"}catch{return"local"}}function I(e){try{localStorage.setItem(o.storageKey,e)}catch(t){console.error("localStorage save error:",t)}}function k(){document.querySelectorAll(".backup-tab").forEach(l=>{l.classList.remove("active","btn-primary"),l.classList.add("btn-outline-primary")}),document.querySelectorAll(".tab-pane").forEach(l=>{l.classList.remove("show","active")});const e=document.querySelector(`[data-tab="${i}"]`),t=document.getElementById(`${i}-tab`);e&&(e.classList.remove("btn-outline-primary"),e.classList.add("active","btn-primary")),t&&t.classList.add("show","active")}function U(e,t,l){e||t?B({month:e||null,year:t||null}):S(),l.reload()}function M(e,t){if(e){B({start_date:e.start,end_date:e.end});const l=document.querySelector(o.dateRangeTextSelector);l&&(l.textContent=e.formatted)}else S();t.reload()}function w(e){if(s[e])return;const t=D({buttonId:`btnDeleteSelected_${e}`,countSelector:".selected-count",onSelectionChange:(a,{count:r,hasSelection:c})=>{console.log(`‚ÑπÔ∏è Selection changed: ${r} ${o.itemName} selected`)}}),l=x({deleteUrl:o.deleteMultipleUrl,itemName:`${e} ${o.itemName}`,onSuccess:(a,r)=>{console.log("‚úÖ Bulk delete success:",a.length,`${e} ${o.itemName} deleted`),d()},onError:a=>{console.error("‚ùå Bulk delete failed:",a)}}),u=_({url:`${o.urlApi}?type=${e}`,beforeSend:a=>Object.assign(a,R()),onSuccess:a=>{d()},onError:(a,r,c)=>{console.error(o.apiErrorPrefix,{error:a,status:r,message:c})}});s[e]=new y(`#${e}Table`,{...u,columns:[{data:"DT_RowIndex",title:"No",orderable:!1,searchable:!1},{data:"name",title:"Nama File",render:(a,r,c)=>(e==="local"?'<i class="fas fa-server text-primary me-2"></i>':'<i class="fab fa-google-drive text-success me-2"></i>')+a},{data:"formatted_size",title:"Ukuran"},{data:"formatted_date",title:"Tanggal"},{data:"actions",title:"Aksi",orderable:!1,render:(a,r,c)=>`
                        <button class="btn btn-info btn-sm me-1 btn-download" data-id="${c.id}" title="Download">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-danger btn-sm btn-delete" data-id="${c.id}" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    `}],buttons:C({tableName:`${e}-${o.tableName}`,exportColumns:o.exportColumns,bulkDeleteHandler:l,bulkDeleteButtonId:`btnDeleteSelected_${e}`,includeCreateButton:!0,createButtonId:`btn-create-${e}`,createButtonText:e==="local"?'<i class="fas fa-server"></i> üíæ Backup Lokal':'<i class="fab fa-google-drive"></i> ‚òÅÔ∏è Backup Google Drive',createHandler:()=>createBackupForTab(e)}),pageLength:o.pageLength,lengthMenu:o.lengthMenu,order:o.defaultOrder,select:!0,responsive:!0,onSelectionChange:t,onError:a=>console.error("‚ùå Table error:",a),initComplete:(a,r)=>{console.log(o.dataLoadedMessage,a.length,"records"),document.querySelector(o.dateRangeSelector)&&($((c,f)=>{U(c,f,s[e])}),new E(o.dateRangeSelector,{buttonText:o.dateRangeButtonText,onDateSelect:c=>{M(c,s[e])}}))}}),setTimeout(()=>{v({buttonSelector:".btn-delete",deleteUrl:a=>`${o.urlApi}/${a}?type=${e}`,tableSelector:`#${e}Table`,onDeleteSuccess:()=>{n==null||n.reload(),d()}})},500)}function O(e){I(e),i=e,k(),s[e]||w(e),n=s[e],window.backupTable=n,n&&n.reload&&n.reload(),d()}async function d(){try{const e=await m.get(o.countsUrl);if(e.data&&typeof e.data=="object"&&(e.data.local_count!==void 0||e.data.google_count!==void 0))g(e.data);else try{const t=await m.post("/api/backup/get-counts-fallback");t.data?g(t.data):g({local_count:0,google_count:3})}catch{g({local_count:0,google_count:3})}}catch{g({local_count:0,google_count:3})}}function g(e){const t=document.getElementById("local-count"),l=document.getElementById("google-count");t&&e&&e.local_count!==void 0&&(t.textContent=e.local_count),l&&e&&e.google_count!==void 0&&(l.textContent=e.google_count)}window.createBackupForTab=async function(e){try{const t=e==="local",l=t?"üíæ Buat Backup Lokal":"‚òÅÔ∏è Buat Backup Google Drive",u=t?"Backup akan disimpan di server lokal":"Backup akan disimpan di Google Drive";if((await Swal.fire({title:l,text:u,icon:"question",showCancelButton:!0,confirmButtonText:t?'<i class="fas fa-server"></i> Buat Backup Lokal':'<i class="fab fa-google-drive"></i> Buat Backup Google Drive',cancelButtonText:"Batal",confirmButtonColor:t?"#0d6efd":"#198754"})).isConfirmed){Swal.fire({title:"Membuat Backup...",html:`Sedang membuat backup ${t?"lokal":"Google Drive"}`,allowOutsideClick:!1,didOpen:()=>{Swal.showLoading()}});const r=new FormData;r.append("save_to_local",t),r.append("save_to_google",!t);const f=(await m.post(o.urlApi,r)).data;if(f.status==="success")Swal.fire({icon:"success",title:"Backup Berhasil!",text:f.message,timer:3e3}),n&&n.reload(),d();else throw new Error(f.message||"Backup gagal")}}catch(t){console.error("Create backup error:",t),Swal.fire({icon:"error",title:"Backup Gagal!",text:t.message||"Terjadi kesalahan saat membuat backup"})}};window.downloadBackup=async function(e){try{const t=await m.get(`${o.urlApi}/${e}/download?type=${i}`,{responseType:"blob"}),l=new Blob([t.data]),u=window.URL.createObjectURL(l),a=document.createElement("a");a.href=u;const r=e.replace(/^(local_|google_)/,"");a.download=r,document.body.appendChild(a),a.click(),document.body.removeChild(a),window.URL.revokeObjectURL(u)}catch(t){console.error("Download error:",t),Swal.fire({icon:"error",title:"Download Gagal!",text:"Terjadi kesalahan saat mengunduh backup"})}};function T(){document.addEventListener("click",e=>{const t=e.target.closest("[data-tab]");if(t){const l=t.dataset.tab;O(l)}}),document.addEventListener("click",e=>{if(e.target.closest(".btn-download")){e.preventDefault();const t=e.target.closest(".btn-download").dataset.id;downloadBackup(t)}})}document.addEventListener("DOMContentLoaded",function(){k(),w(i),n=s[i],window.backupTable=n,T(),d()});function K(){console.log("üîÑ Backup module initialized successfully!"),document.readyState!=="loading"&&(k(),w(i),n=s[i],window.backupTable=n,T(),d())}export{K as default};
