import m from"./axiosClient-DXQnQ5LA.js";import"./badgeUpdater-D7fo0NmU.js";import{s as M}from"./modalHandler-l1VpEcIP.js";class I{constructor(e={}){this.options={uploadUrl:"/api/media/upload/file",allowedTypes:["image/*","video/*","audio/*","application/*"],maxFileSize:10*1024*1024,multiple:!0,autoUpload:!0,collection:null,onUploadStart:null,onUploadProgress:null,onUploadSuccess:null,onUploadError:null,onUploadComplete:null,...e},this.uploadQueue=[],this.isUploading=!1,this.init()}init(){this.bindEvents()}bindEvents(){const e=document.getElementById("uploadArea"),t=document.getElementById("fileInput"),o=e==null?void 0:e.querySelector("button");!e||!t||e.dataset.bound||(e.dataset.bound="true",t.addEventListener("change",s=>{this.handleFiles(s.target.files)}),o&&o.addEventListener("click",s=>{s.stopPropagation(),t.click()}),e.addEventListener("dragover",s=>{s.preventDefault(),e.classList.add("dragover")}),e.addEventListener("dragleave",s=>{e.contains(s.relatedTarget)||e.classList.remove("dragover")}),e.addEventListener("drop",s=>{s.preventDefault(),e.classList.remove("dragover"),this.handleFiles(s.dataTransfer.files)}))}async handleFiles(e){if(!e||e.length===0)return;const t=[];for(const s of Array.from(e))if(this.validateFile(s,!1))try{const i=await this.processFile(s);t.push(i)}catch(i){this.showError(`Gagal memproses ${s.name}: ${i.message}`)}if(t.length===0){this.showError("Tidak ada file yang valid untuk diupload");return}t.forEach(s=>{let i;if(typeof crypto<"u"&&crypto.getRandomValues){const a=new Uint32Array(1);crypto.getRandomValues(a),i=a[0]}else i=Math.random();this.uploadQueue.push({file:s,id:Date.now()+i,status:"pending",progress:0})}),this.options.autoUpload&&await this.startUpload();const o=document.getElementById("fileInput");o&&(o.value="")}validateFile(e,t=!0){if(t&&e.size>this.options.maxFileSize)return this.showError(`File "${e.name}" terlalu besar (${this.formatFileSize(e.size)}). Maksimal ${this.formatFileSize(this.options.maxFileSize)} per file.`),!1;if(this.options.allowedTypes.length>0&&!this.options.allowedTypes.some(s=>s.endsWith("/*")?e.type.startsWith(s.replace("/*","/")):e.type===s)){const s=e.name.split(".").pop().toUpperCase();return this.showError(`File "${e.name}" (${s}) tidak didukung. Pilih file gambar, video, atau dokumen.`),!1}return!0}async processFile(e){if(!e.type.startsWith("image/"))return e;const t=2*1024*1024;return e.size<=t?e:(this.showSuccess(`Mengompres gambar "${e.name}"...`),await this.compressImage(e,t))}async compressImage(e,t){return new Promise((o,s)=>{const i=document.createElement("canvas"),a=i.getContext("2d"),n=new Image;n.onload=()=>{let{width:r,height:d}=n;const l=1920;(r>l||d>l)&&(r>d?(d=d*l/r,r=l):(r=r*l/d,d=l)),i.width=r,i.height=d,a.drawImage(n,0,0,r,d),this.tryCompress(i,e.name,t,.8).then(o).catch(s)},n.onerror=()=>s(new Error("Gagal memuat gambar")),n.src=URL.createObjectURL(e)})}async tryCompress(e,t,o,s){return new Promise(i=>{e.toBlob(a=>{if(a.size<=o||s<=.1){const n=new File([a],t,{type:"image/webp",lastModified:Date.now()}),r=((1-a.size/o)*100).toFixed(1);this.showSuccess(`Gambar dikompres ${r}% (${this.formatFileSize(a.size)})`),i(n)}else this.tryCompress(e,t,o,s-.1).then(i)},"image/webp",s)})}async startUpload(){if(!this.isUploading){this.isUploading=!0,this.showProgress(),this.options.onUploadStart&&this.options.onUploadStart(this.uploadQueue);try{for(let e=0;e<this.uploadQueue.length;e++){const t=this.uploadQueue[e];if(t.status==="pending"){t.status="uploading";try{const o=await this.uploadFile(t.file,s=>{t.progress=s,this.updateProgress()});t.status="completed",t.result=o,this.options.onUploadSuccess&&this.options.onUploadSuccess(o,t.file)}catch(o){t.status="error",t.error=o,this.options.onUploadError&&this.options.onUploadError(o,t.file);let s;o.response&&o.response.data?o.response.data.user_message?s=`${t.file.name}: ${o.response.data.user_message}`:o.response.data.message?s=`${t.file.name}: ${o.response.data.message}`:s=`Gagal upload ${t.file.name}`:s=`Gagal upload ${t.file.name}: ${o.message}`,this.showError(s)}}}}finally{this.isUploading=!1,this.hideProgress(),this.options.onUploadComplete&&this.options.onUploadComplete(this.uploadQueue),this.uploadQueue=this.uploadQueue.filter(e=>e.status==="error")}}}async uploadFile(e,t){var s,i;const o=new FormData;o.append("file",e),this.options.collection&&o.append("collection",this.options.collection);try{return(await m.post(this.options.uploadUrl,o,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:n=>{if(t&&n.total){const r=Math.round(n.loaded*100/n.total);t(r)}}})).data}catch(a){throw console.error("Upload error:",a),new Error(((i=(s=a.response)==null?void 0:s.data)==null?void 0:i.message)||a.message||"Upload failed")}}showProgress(){const e=document.querySelector(".upload-content"),t=document.querySelector(".upload-progress");e&&(e.style.display="none"),t&&(t.style.display="block")}hideProgress(){const e=document.querySelector(".upload-content"),t=document.querySelector(".upload-progress");e&&(e.style.display="block"),t&&(t.style.display="none")}updateProgress(){const e=this.uploadQueue.length,t=this.uploadQueue.filter(n=>n.status==="completed"||n.status==="error").length,o=this.uploadQueue.find(n=>n.status==="uploading"),s=o?o.progress:0,i=e>0?(t+s/100)/e*100:0,a=document.querySelector(".progress-bar");a&&(a.style.width=Math.round(i)+"%"),this.options.onUploadProgress&&this.options.onUploadProgress(i,t,e)}showError(e){typeof window.showToast=="function"?window.showToast(e,"error"):(console.error(e),alert(e))}showSuccess(e){typeof window.showToast=="function"?window.showToast(e,"success"):console.log(e)}formatFileSize(e){if(e===0)return"0 Bytes";const t=1024,o=["Bytes","KB","MB","GB"],s=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,s)).toFixed(2))+" "+o[s]}setCollection(e){this.options.collection=e}clearQueue(){this.uploadQueue=[]}getQueue(){return this.uploadQueue}}class y{constructor(e={}){this.options={containerId:"imageEditor",imageId:"cropperImage",saveUrl:"/api/media/upload/file",aspectRatio:NaN,viewMode:1,dragMode:"move",autoCropArea:1,restore:!1,guides:!0,center:!0,highlight:!1,cropBoxMovable:!0,cropBoxResizable:!0,toggleDragModeOnDblclick:!1,onSave:null,onCancel:null,...e},this.cropper=null,this.isEditing=!1,this.currentItem=null,this.init()}init(){this.loadCropperJS(),this.bindEvents()}loadCropperJS(){return window.Cropper?Promise.resolve():new Promise((e,t)=>{const o=document.createElement("script");o.src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js",o.onload=e,o.onerror=t,document.head.appendChild(o)})}bindEvents(){Object.entries({cropFree:()=>this.setCropMode("free"),cropSquare:()=>this.setCropMode(1),cropCircle:()=>this.setCropMode("circle"),crop16x9:()=>this.setCropMode(1.7777777777777777),rotateLeft:()=>this.rotate(-90),rotateRight:()=>this.rotate(90),flipH:()=>this.scaleX(-1),flipV:()=>this.scaleY(-1),applyEdit:()=>this.save(),cancelEdit:()=>this.cancel()}).forEach(([t,o])=>{const s=document.getElementById(t);s&&!s.dataset.bound&&(s.addEventListener("click",o),s.dataset.bound="true")})}async startEdit(e,t=null){await this.loadCropperJS(),this.currentItem=t,this.isEditing=!0;const o=document.getElementById(this.options.containerId);o&&(o.style.display="block");const s=document.getElementById(this.options.imageId);s&&(s.src=e,s.onload=()=>{this.initializeCropper(s)}),this.updateButtons(!0)}initializeCropper(e){this.cropper&&this.cropper.destroy(),this.cropper=new Cropper(e,{aspectRatio:this.options.aspectRatio,viewMode:this.options.viewMode,dragMode:this.options.dragMode,autoCropArea:this.options.autoCropArea,restore:this.options.restore,guides:this.options.guides,center:this.options.center,highlight:this.options.highlight,cropBoxMovable:this.options.cropBoxMovable,cropBoxResizable:this.options.cropBoxResizable,toggleDragModeOnDblclick:this.options.toggleDragModeOnDblclick})}setCropMode(e){this.cropper&&(e==="free"?(this.cropper.setAspectRatio(NaN),this.removeCropBoxStyling()):e==="circle"?(this.cropper.setAspectRatio(1),this.addCircleCropStyling()):(this.cropper.setAspectRatio(e),this.removeCropBoxStyling()))}addCircleCropStyling(){const e=document.querySelector(".cropper-crop-box");e&&(e.style.borderRadius="50%")}removeCropBoxStyling(){const e=document.querySelector(".cropper-crop-box");e&&(e.style.borderRadius="0")}rotate(e){this.cropper&&this.cropper.rotate(e)}scaleX(e){this.cropper&&this.cropper.scaleX(e)}scaleY(e){this.cropper&&this.cropper.scaleY(e)}async save(){var e,t,o,s;if(this.cropper)try{const i=this.cropper.getCroppedCanvas({width:800,height:600,minWidth:256,minHeight:256,maxWidth:4096,maxHeight:4096,fillColor:"#fff",imageSmoothingEnabled:!1,imageSmoothingQuality:"high"}),a=await new Promise(l=>{i.toBlob(l,"image/webp",.85)}),n=new FormData,r=((e=this.currentItem)==null?void 0:e.file_name)||"edited_image.webp";n.append("file",a,r),(t=this.currentItem)!=null&&t.collection&&n.append("collection",this.currentItem.collection);const d=await m.post(this.options.saveUrl,n,{headers:{"Content-Type":"multipart/form-data"}});this.updatePreviewAfterSave(d.data),this.options.onSave&&this.options.onSave(d.data,this.currentItem),this.showSuccess("Image updated successfully"),this.cancel()}catch(i){console.error("Save error:",i),this.showError("Failed to save image: "+(((s=(o=i.response)==null?void 0:o.data)==null?void 0:s.message)||i.message))}}cancel(){this.isEditing=!1,this.cropper&&(this.cropper.destroy(),this.cropper=null);const e=document.getElementById(this.options.containerId);e&&(e.style.display="none"),this.updateButtons(!1),this.options.onCancel&&this.options.onCancel(this.currentItem),this.currentItem=null}updatePreviewAfterSave(e){const t=document.getElementById("mediaPreview");if(t&&e.url){const o=e.url+"?t="+Date.now(),s=t.querySelector("img");s?s.src=o:t.innerHTML=`<img src="${o}" alt="${e.name||"Updated image"}" style="max-width: 100%; max-height: 300px; width: auto; height: auto; object-fit: contain; border-radius: 4px;">`}t&&(t.style.display="block")}updateButtons(e){Object.entries({editImage:!e,applyEdit:e,cancelEdit:e,saveMedia:!e}).forEach(([o,s])=>{const i=document.getElementById(o);i&&(i.style.display=s?"inline-block":"none")})}showSuccess(e){typeof window.showToast=="function"?window.showToast(e,"success"):console.log(e)}showError(e){typeof window.showToast=="function"?window.showToast(e,"error"):(console.error(e),alert(e))}isCurrentlyEditing(){return this.isEditing}getCropper(){return this.cropper}destroy(){this.cropper&&(this.cropper.destroy(),this.cropper=null),this.isEditing=!1,this.currentItem=null}}document.addEventListener("DOMContentLoaded",()=>{document.getElementById("imageEditor")&&!window.imageCropper&&(window.imageCropper=new y)});class b{constructor(e={}){this.options={multiple:!1,allowedTypes:[],onSelect:null,modalId:"mediaPickerModal",...e},this.selectedMedia=[],this.init()}init(){window.addEventListener("message",e=>{e.data.type==="MEDIA_SELECTED"&&this.handleMediaSelection(e.data.media)})}open(){const e=`/media-library?mode=picker&multiple=${this.options.multiple}&types=${this.options.allowedTypes.join(",")}`;M(e,"picker")}handleMediaSelection(e){this.options.multiple?this.selectedMedia.push(e):this.selectedMedia=[e],this.options.onSelect&&typeof this.options.onSelect=="function"&&this.options.onSelect(this.options.multiple?this.selectedMedia:e);const t=document.getElementById(this.options.modalId);if(t){const o=bootstrap.Modal.getInstance(t);o&&o.hide()}}clear(){this.selectedMedia=[]}getSelected(){return this.options.multiple?this.selectedMedia:this.selectedMedia[0]||null}}function F(c={}){return new Promise(e=>{new b({...c,onSelect:o=>{e(o)}}).open()})}function w(){document.querySelectorAll("[data-media-picker]").forEach(c=>{c.dataset.bound||(c.addEventListener("click",async e=>{e.preventDefault();const t={multiple:c.dataset.multiple==="true",allowedTypes:c.dataset.types?c.dataset.types.split(","):[]};try{const o=await F(t),s=new CustomEvent("mediaSelected",{detail:{media:o,button:c}});c.dispatchEvent(s);const i=c.dataset.target;if(i){const n=document.querySelector(i);n&&(t.multiple?n.value=o.map(r=>r.url).join(","):n.value=o.url,n.dispatchEvent(new Event("change")))}const a=c.dataset.preview;if(a&&!t.multiple){const n=document.querySelector(a);n&&(o.mime_type&&o.mime_type.startsWith("image/")?n.innerHTML=`<img src="${o.url}" alt="${o.name}" class="img-fluid" style="max-height: 200px;">`:n.innerHTML=`<p>Selected: ${o.name}</p>`)}}catch(o){console.error("Media picker error:",o)}}),c.dataset.bound="true")})}document.addEventListener("DOMContentLoaded",w);document.addEventListener("contentLoaded",w);class v{constructor(e={}){this.options={menuId:"contextMenu",mediaMenuId:"mediaContextMenu",folderMenuId:"folderContextMenu",onCopy:null,onMove:null,onRename:null,onDelete:null,...e},this.target=null,this.targetType=null,this.isVisible=!1,this.init()}init(){this.bindEvents()}bindEvents(){document.addEventListener("contextmenu",t=>this.handleContextMenu(t)),document.addEventListener("click",()=>this.hide());const e=document.getElementById(this.options.menuId);e&&e.addEventListener("click",t=>t.stopPropagation()),this.bindActionButtons()}bindActionButtons(){const e=document.getElementById("copyToRoot");e&&!e.dataset.bound&&(e.addEventListener("click",()=>this.copyToFolder("")),e.dataset.bound="true");const t=document.getElementById("copyToFolder");t&&!t.dataset.bound&&(t.addEventListener("click",()=>this.showFolderModal("copy")),t.dataset.bound="true");const o=document.getElementById("moveToRoot");o&&!o.dataset.bound&&(o.addEventListener("click",()=>this.moveToFolder("")),o.dataset.bound="true");const s=document.getElementById("moveToFolder");s&&!s.dataset.bound&&(s.addEventListener("click",()=>this.showFolderModal("move")),s.dataset.bound="true");const i=document.getElementById("moveFolderToRoot");i&&!i.dataset.bound&&(i.addEventListener("click",()=>this.moveToFolder("")),i.dataset.bound="true");const a=document.getElementById("moveFolderTo");a&&!a.dataset.bound&&(a.addEventListener("click",()=>this.showFolderModal("moveFolder")),a.dataset.bound="true");const n=document.getElementById("renameFolder");n&&!n.dataset.bound&&(n.addEventListener("click",()=>this.showRenameFolderModal()),n.dataset.bound="true");const r=document.getElementById("renameFolderBtn");r&&!r.dataset.bound&&(r.addEventListener("click",()=>this.renameFolder()),r.dataset.bound="true");const d=document.getElementById("deleteFolder");d&&!d.dataset.bound&&(d.addEventListener("click",()=>this.deleteFolder()),d.dataset.bound="true")}handleContextMenu(e){const t=e.target.closest(".media-item:not(.folder-item)"),o=e.target.closest(".folder-item");if(!t&&!o){this.hide();return}e.preventDefault(),t?this.showForMedia(t,e.clientX,e.clientY):o&&this.showForFolder(o,e.clientX,e.clientY)}async showForMedia(e,t,o){this.target=parseInt(e.dataset.id),this.targetType="media";const s=document.getElementById(this.options.mediaMenuId),i=document.getElementById(this.options.folderMenuId);s&&(s.style.display="block"),i&&(i.style.display="none"),await this.populateContextFolders(),this.show(t,o)}async showForFolder(e,t,o){this.target=e.dataset.folder,this.targetType="folder";const s=document.getElementById(this.options.mediaMenuId),i=document.getElementById(this.options.folderMenuId);s&&(s.style.display="none"),i&&(i.style.display="block"),await this.populateContextFoldersForFolder(),this.show(t,o)}show(e,t){const o=document.getElementById(this.options.menuId);if(!o)return;o.style.display="block",o.style.position="fixed";const s=300,i=400;let a=e,n=t;a+s>window.innerWidth&&(a=window.innerWidth-s-10),n+i>window.innerHeight&&(n=window.innerHeight-i-10),a=Math.max(10,a),n=Math.max(10,n),o.style.left=a+"px",o.style.top=n+"px",this.isVisible=!0}hide(){const e=document.getElementById(this.options.menuId);e&&(e.style.display="none"),this.target=null,this.targetType=null,this.isVisible=!1}async populateContextFolders(){try{const o=((await m.get("/api/media/folders")).data.data||[]).map(a=>`
                <a class="dropdown-item" href="#" data-folder="${a.path}">
                    <i class="fas fa-folder"></i> ${a.name}
                </a>
            `).join(""),s=document.getElementById("folderListCopy");s&&(s.innerHTML=o,s.querySelectorAll("a").forEach(a=>{a.addEventListener("click",n=>{n.preventDefault(),this.copyToFolder(n.target.dataset.folder)})}));const i=document.getElementById("folderListMove");i&&(i.innerHTML=o,i.querySelectorAll("a").forEach(a=>{a.addEventListener("click",n=>{n.preventDefault(),this.moveToFolder(n.target.dataset.folder)})}))}catch{console.error("Failed to load folders for context menu")}}async populateContextFoldersForFolder(){try{const t=(await m.get("/api/media/folders")).data.data||[],o=document.getElementById("folderListForFolder");o&&(o.innerHTML=t.map(s=>`
                    <a class="dropdown-item" href="#" data-folder="${s.path}">
                        <i class="fas fa-folder"></i> ${s.name}
                    </a>
                `).join(""),o.querySelectorAll("a").forEach(s=>{s.addEventListener("click",i=>{i.preventDefault(),this.moveToFolder(i.target.dataset.folder)})}))}catch{console.error("Failed to load folders for folder context menu")}}async copyToFolder(e){var s,i;const t=this.target||this.savedTarget,o=this.targetType||this.savedTargetType;if(!t){console.error("No target found for copy operation");return}try{o==="media"&&(await m.post("/api/media/copy",{media_id:t,target_folder:e||""}),this.showSuccess(`Media copied to ${e||"root"} successfully`),this.options.onCopy&&this.options.onCopy(t,e)),this.savedTarget=null,this.savedTargetType=null}catch(a){this.showError(`Failed to copy media: ${((i=(s=a.response)==null?void 0:s.data)==null?void 0:i.message)||a.message}`)}}async moveToFolder(e){var s,i;const t=this.target||this.savedTarget,o=this.targetType||this.savedTargetType;if(!t){console.error("No target found for move operation");return}try{o==="media"?(await m.post("/api/media/move",{media_id:t,target_folder:e||""}),this.showSuccess(`Media moved to ${e||"root"} successfully`)):o==="folder"&&(await m.post("/api/media/folders/move",{source:t,target:e||""}),this.showSuccess(`Folder moved to ${e||"root"} successfully`)),this.options.onMove&&this.options.onMove(t,e,o),this.savedTarget=null,this.savedTargetType=null}catch(a){this.showError(`Failed to move ${o}: ${((i=(s=a.response)==null?void 0:s.data)==null?void 0:i.message)||a.message}`)}}showRenameFolderModal(){if(!this.target)return;const e=this.target.split("/").pop(),t=document.getElementById("newFolderName");t&&(t.value=e);const o=document.getElementById("renameFolderModal");o&&(o.dataset.target=this.target);const s=document.getElementById(this.options.menuId);s&&(s.style.display="none"),o&&new bootstrap.Modal(o).show()}async renameFolder(){var i,a;const e=document.getElementById("newFolderName"),t=document.getElementById("renameFolderModal"),o=e==null?void 0:e.value.trim(),s=t==null?void 0:t.dataset.target;if(!o||!s){this.showError("Missing folder name or target");return}try{await m.post("/api/media/folders/rename",{oldPath:s,newName:o}),this.showSuccess("Folder renamed successfully");const n=bootstrap.Modal.getInstance(t);n&&n.hide(),this.options.onRename&&this.options.onRename(s,o),this.target=null,this.targetType=null}catch(n){this.showError(((a=(i=n.response)==null?void 0:i.data)==null?void 0:a.message)||"Failed to rename folder"),this.target=null,this.targetType=null}}showSuccess(e){typeof window.showToast=="function"?window.showToast(e,"success"):console.log(e)}showError(e){typeof window.showToast=="function"?window.showToast(e,"error"):(console.error(e),alert(e))}getTarget(){return{target:this.target,type:this.targetType}}isContextMenuVisible(){return this.isVisible}async deleteFolder(){var t,o;if(!this.target||this.targetType!=="folder")return;const e=this.target.split("/").pop();if(confirm(`Are you sure you want to delete folder "${e}" and all its contents?`))try{await m.delete("/api/media/folders",{data:{folder_path:this.target}}),this.showSuccess("Folder deleted successfully"),this.options.onDelete&&this.options.onDelete(this.target),this.hide()}catch(s){this.showError("Failed to delete folder: "+(((o=(t=s.response)==null?void 0:t.data)==null?void 0:o.message)||s.message))}}async showFolderModal(e){this.currentAction=e,this.savedTarget=this.target,this.savedTargetType=this.targetType;const t=document.getElementById("folderModalTitle");if(t){const s={copy:"Copy to Folder",move:"Move to Folder",moveFolder:"Move Folder to"};t.textContent=s[e]||"Select Folder"}await this.populateFolderModal(),this.hide();const o=document.getElementById("folderSelectionModal");o&&new bootstrap.Modal(o).show()}async populateFolderModal(){try{const t=(await m.get("/api/media/folders")).data.data||[],o=document.getElementById("folderList");if(!o)return;if(t.length===0){o.innerHTML='<div class="text-center text-muted p-3">No folders available</div>';return}let s=`
                <div class="folder-item d-flex align-items-center p-2 border-bottom" data-folder="" style="cursor: pointer; background-color: #f8f9fa;">
                    <i class="fas fa-home text-primary me-2"></i>
                    <div class="flex-grow-1">
                        <div class="fw-bold">üìÅ Root Folder</div>
                        <small class="text-muted">Move to main directory</small>
                    </div>
                </div>
            `;s+=t.map(i=>`
                <div class="folder-item d-flex align-items-center p-2 border-bottom" data-folder="${i.path}" style="cursor: pointer;">
                    <i class="fas fa-folder text-warning me-2"></i>
                    <div class="flex-grow-1">
                        <div class="fw-bold">${i.name}</div>
                        <small class="text-muted">${i.path}</small>
                    </div>
                    <small class="text-muted">${i.count||0} files</small>
                </div>
            `).join(""),o.innerHTML=s,o.querySelectorAll(".folder-item").forEach(i=>{i.addEventListener("click",()=>{const a=i.dataset.folder;this.handleFolderSelection(a)})}),this.setupFolderSearch(t)}catch(e){console.error("Failed to load folders for modal:",e)}}setupFolderSearch(e){const t=document.getElementById("folderSearch");t&&t.addEventListener("input",o=>{const s=o.target.value.toLowerCase(),i=document.getElementById("folderList");if(!s){i.querySelectorAll(".folder-item").forEach(a=>{a.style.display="flex"});return}i.querySelectorAll(".folder-item").forEach(a=>{const n=a.dataset.folder.toLowerCase();a.querySelector(".fw-bold").textContent.toLowerCase().includes(s)||n.includes(s)?a.style.display="flex":a.style.display="none"})})}handleFolderSelection(e){const t=document.getElementById("folderSelectionModal"),o=bootstrap.Modal.getInstance(t);switch(o&&o.hide(),this.currentAction){case"copy":this.copyToFolder(e);break;case"move":this.moveToFolder(e);break;case"moveFolder":this.moveToFolder(e);break}}destroy(){this.hide()}}document.addEventListener("DOMContentLoaded",()=>{document.getElementById("contextMenu")&&!window.contextMenu&&(window.contextMenu=new v)});class B{constructor(e={}){const t={...window.mediaLibraryConfig,...e};this.selectedItems=new Set,this.currentView=localStorage.getItem("mediaLibraryView")||"grid",this.mediaData=[],this.filteredData=[],this.currentEditItem=null,this.currentFolder=t.folder||localStorage.getItem("mediaCurrentFolder")||"",this.folders=[],this.contextMenuTarget=null,this.contextMenuType=null,this.config=t,this.mediaUpload=null,this.imageCropper=null,this.mediaPicker=null,this.contextMenu=null,this.init(),window.mediaLibraryGlobalVar&&(window[window.mediaLibraryGlobalVar]=this)}init(){this.initializeComponents(),this.bindEvents(),this.loadMedia()}initializeComponents(){try{this.mediaUpload=new I({collection:this.currentFolder,onUploadSuccess:(e,t)=>{this.showToast("success",`${t.name} uploaded successfully`)},onUploadComplete:e=>{this.loadMedia();const t=e.filter(o=>o.status==="completed").length;t>0&&this.showToast("success",`${t} file(s) uploaded successfully`)},onUploadError:(e,t)=>{this.showToast("error",`Failed to upload ${t.name}: ${e.message}`)}}),window.mediaUpload=this.mediaUpload}catch(e){console.warn("MediaUpload component not available:",e)}try{this.imageCropper=new y({onSave:(e,t)=>{e&&e.url&&this.currentEditItem&&(this.currentEditItem.url=e.url,this.currentEditItem.name=e.name||this.currentEditItem.name),this.loadMedia()},onCancel:e=>{const t=document.getElementById("mediaPreview");t&&(t.style.display="block")}})}catch(e){console.warn("ImageCropper component not available:",e)}try{this.contextMenu=new v({onCopy:(e,t)=>{this.loadMedia()},onMove:(e,t,o)=>{this.loadMedia()},onRename:(e,t)=>{this.loadMedia()},onDelete:e=>{if(this.currentFolder===e){const t=e.includes("/")?e.substring(0,e.lastIndexOf("/")):"";this.navigateToFolder(t)}else this.loadMedia()}})}catch(e){console.warn("ContextMenu component not available:",e)}}bindEvents(){document.querySelectorAll(".view-toggle").forEach(p=>{p.addEventListener("click",g=>{document.querySelectorAll(".view-toggle").forEach(E=>E.classList.remove("active")),g.target.classList.add("active"),this.currentView=g.target.dataset.view,localStorage.setItem("mediaLibraryView",this.currentView),this.renderMedia()})}),document.querySelectorAll(".view-toggle").forEach(p=>{p.dataset.view===this.currentView?p.classList.add("active"):p.classList.remove("active")}),document.getElementById("folderBreadcrumb")&&this.updateBreadcrumb();const e=document.getElementById("collectionFilter"),t=document.getElementById("typeFilter"),o=document.getElementById("searchMedia");e&&e.addEventListener("change",()=>this.applyFilters()),t&&t.addEventListener("change",()=>this.applyFilters()),o&&o.addEventListener("input",()=>this.applyFilters());const s=document.getElementById("deleteSelected"),i=document.getElementById("clearSelection"),a=document.getElementById("selectAllList");s&&s.addEventListener("click",()=>this.deleteSelected()),i&&i.addEventListener("click",()=>this.clearSelection()),a&&a.addEventListener("change",p=>this.selectAll(p.target.checked));const n=document.getElementById("createFolder"),r=document.getElementById("createFolderBtn");n&&n.addEventListener("click",()=>this.showCreateFolderModal()),r&&r.addEventListener("click",()=>this.createFolder());const d=document.getElementById("saveMedia"),l=document.getElementById("deleteMedia"),u=document.getElementById("editImage"),h=document.getElementById("applyEdit"),f=document.getElementById("cancelEdit");d&&d.addEventListener("click",()=>this.saveMediaDetails()),l&&l.addEventListener("click",()=>this.deleteCurrentMedia()),u&&u.addEventListener("click",()=>this.startImageEdit()),h&&h.addEventListener("click",()=>this.applyImageEdit()),f&&f.addEventListener("click",()=>this.cancelImageEdit())}updateUploadCollection(){this.mediaUpload&&this.mediaUpload.setCollection(this.currentFolder)}async loadMedia(){try{const e=new URLSearchParams;this.currentFolder&&e.append("folder",this.currentFolder),e.append("_t",Date.now());const t=await m.get(`/api/media-management/json?${e}`);this.mediaData=[],this.folders=[],this.allMediaData=[],this.filteredData=[],this.mediaData=t.data.data||[],this.folders=t.data.folders||[],this.allMediaData=t.data.all_data||this.mediaData,this.applyFilters(),this.renderMedia(),this.updateMediaCount()}catch(e){console.error("Failed to load media:",e),this.showToast("error","Failed to load media"),this.mediaData=[],this.folders=[],this.allMediaData=[],this.filteredData=[],this.renderMedia(),this.updateMediaCount()}}applyFilters(){const e=document.getElementById("collectionFilter"),t=document.getElementById("typeFilter"),o=document.getElementById("searchMedia"),s=e?e.value:"",i=t?t.value:"",a=o?o.value.toLowerCase():"",n=!this.currentFolder&&a,r=n?this.allMediaData:this.mediaData;this.filteredData=r.filter(d=>{const l=!s||d.collection===s,u=!i||d.mime_type&&d.mime_type.startsWith(i),h=!a||d.name.toLowerCase().includes(a)||d.file_name.toLowerCase().includes(a);return l&&u&&h}),this.updateSearchIndicator(n,a),this.renderMedia(),this.updateMediaCount()}updateSearchIndicator(e,t){const o=document.getElementById("searchMedia"),s=document.getElementById("searchScope");if(o)if(t){const i=e?"üåê Searching in all folders":"üìÅ Searching in current folder";o.title=`${i}: "${t}"`,o.style.borderColor=e?"#007bff":"#28a745",s&&(s.textContent=i,s.style.display="block",s.style.color=e?"#007bff":"#28a745")}else o.title="Search media...",o.style.borderColor="",s&&(s.style.display="none")}renderMedia(){document.getElementById("mediaGrid")&&(this.currentView==="grid"?this.renderGridView():this.renderListView())}renderGridView(){const e=document.getElementById("mediaGrid"),t=document.getElementById("mediaList");if(!e)return;if(t&&(t.style.display="none"),e.style.display="grid",this.filteredData.length===0&&this.folders.length===0){e.innerHTML=`
                <div class="col-12 text-center py-5">
                    <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No media files found</p>
                </div>
            `;return}let o="";this.folders&&this.folders.length>0&&(o=this.folders.map(i=>`
                <div class="media-item folder-item" data-folder="${i.path}">
                    <div style="width: 100%; height: 120px; display: flex; align-items: center; justify-content: center; border-radius: 4px;">
                        <i class="fas fa-folder text-warning" style="font-size: 48px;"></i>
                    </div>
                    <div class="mt-2">
                        <small class="fw-bold d-block text-truncate" title="${i.name}">üìÅ ${i.name}</small>
                        <small class="text-muted">${i.count||0} ${i.count===1?"item":"items"}</small>
                    </div>
                </div>
            `).join(""));let s=this.filteredData.map(i=>`
            <div class="media-item ${this.selectedItems.has(i.id)?"selected":""}" 
                 data-id="${i.id}" data-url="${i.url}" data-name="${i.name}">
                ${this.getMediaPreview(i)}
                <div class="mt-2">
                    <small class="fw-bold d-block text-truncate" title="${i.name}">${i.name}</small>
                    <small class="text-muted">${i.size}</small>
                </div>
                <div class="media-item-overlay">
                    <input type="checkbox" ${this.selectedItems.has(i.id)?"checked":""}>
                </div>
                <div class="media-item-actions" style="position: absolute; top: 5px; right: 5px; display: none;">
                    <button class="btn btn-sm btn-primary btn-edit-grid" data-id="${i.id}" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger btn-delete-grid" data-id="${i.id}" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join("");e.innerHTML=o+s,e.querySelectorAll(".folder-item").forEach(i=>{i.addEventListener("dblclick",a=>{a.preventDefault();const n=a.currentTarget.dataset.folder;this.navigateToFolder(n)})}),e.querySelectorAll(".media-item:not(.folder-item)").forEach(i=>{const a=parseInt(i.dataset.id);if(!a)return;i.addEventListener("mouseenter",()=>{const l=i.querySelector(".media-item-actions");l&&(l.style.display="block")}),i.addEventListener("mouseleave",()=>{const l=i.querySelector(".media-item-actions");l&&(l.style.display="none")}),i.addEventListener("click",l=>{l.target.type==="checkbox"||l.target.closest("button")||this.toggleSelection(a)}),i.addEventListener("dblclick",l=>{if(l.preventDefault(),new URLSearchParams(window.location.search).get("mode")==="picker"&&window.parent!==window){const h=this.mediaData.find(f=>f.id===a);if(h){window.parent.postMessage({type:"MEDIA_SELECTED",media:{id:h.id,url:h.url,name:h.name}},"*");return}}this.showMediaDetails(a)});const n=i.querySelector('input[type="checkbox"]');n&&n.addEventListener("change",l=>{l.stopPropagation(),this.toggleSelection(a)});const r=i.querySelector(".btn-edit-grid");r&&r.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),this.showMediaDetails(a)});const d=i.querySelector(".btn-delete-grid");d&&d.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),this.deleteMedia(a)})})}renderListView(){const e=document.getElementById("mediaGrid"),t=document.getElementById("mediaList"),o=document.getElementById("mediaListBody");if(!e||!t||!o)return;if(e.style.display="none",t.style.display="block",this.filteredData.length===0&&this.folders.length===0){o.innerHTML=`
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <i class="fas fa-folder-open fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">No media files found</p>
                    </td>
                </tr>
            `;return}let s="";this.folders&&this.folders.length>0&&(s=this.folders.map(a=>`
                <tr class="folder-list-item" data-folder="${a.path}">
                    <td></td>
                    <td>
                        <i class="fas fa-folder fa-2x text-warning"></i>
                    </td>
                    <td>
                        <div class="fw-bold">üìÅ ${a.name}</div>
                        <small class="text-muted">${a.count||0} ${a.count===1?"item":"items"}</small>
                    </td>
                    <td><span class="badge bg-warning">Folder</span></td>
                    <td>-</td>
                    <td>-</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary btn-open-folder" data-folder="${a.path}" title="Open">
                            <i class="fas fa-folder-open"></i>
                        </button>
                    </td>
                </tr>
            `).join(""));let i=this.filteredData.map(a=>{var n;return`
            <tr class="${this.selectedItems.has(a.id)?"table-primary":""}" data-id="${a.id}">
                <td>
                    <input type="checkbox" ${this.selectedItems.has(a.id)?"checked":""}>
                </td>
                <td>${this.getMediaPreview(a,"small")}</td>
                <td>
                    <div class="fw-bold">${a.name}</div>
                    <small class="text-muted">${a.file_name}</small>
                </td>
                <td><span class="badge bg-secondary">${((n=a.mime_type)==null?void 0:n.split("/")[0])||"unknown"}</span></td>
                <td>${a.size}</td>
                <td>${a.created_at}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary btn-edit" data-id="${a.id}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger btn-delete-single" data-id="${a.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `}).join("");o.innerHTML=s+i,o.querySelectorAll(".folder-list-item").forEach(a=>{const n=a.dataset.folder;a.addEventListener("dblclick",d=>{d.preventDefault(),this.navigateToFolder(n)}),a.querySelector(".btn-open-folder").addEventListener("click",d=>{d.preventDefault(),this.navigateToFolder(n)})}),o.querySelectorAll("tr[data-id]").forEach(a=>{const n=parseInt(a.dataset.id);a.addEventListener("dblclick",u=>{u.preventDefault(),this.showMediaDetails(n)});const r=a.querySelector('input[type="checkbox"]');r&&r.addEventListener("change",u=>{u.stopPropagation(),this.toggleSelection(n)});const d=a.querySelector(".btn-edit");d&&d.addEventListener("click",u=>{u.preventDefault(),this.showMediaDetails(n)});const l=a.querySelector(".btn-delete-single");l&&l.addEventListener("click",u=>{u.preventDefault(),this.deleteMedia(n)})})}getMediaPreview(e,t="normal"){var r;let o="";if(t==="small"?o="width: 40px; height: 40px;":t==="modal"&&(o="max-width: 100%; max-height: 300px; width: auto; height: auto;"),e.mime_type&&e.mime_type.startsWith("image/"))return`<img src="${e.url}" alt="${e.name}" style="${o} object-fit: contain; border-radius: 4px;">`;const s=t==="small"?"fa-lg":"fa-3x",i={video:"fa-video",audio:"fa-music",application:"fa-file-alt",text:"fa-file-text"},a=((r=e.mime_type)==null?void 0:r.split("/")[0])||"unknown";return`<div class="file-icon"><i class="fas ${i[a]||"fa-file"} ${s}"></i></div>`}toggleSelection(e){this.selectedItems.has(e)?this.selectedItems.delete(e):this.selectedItems.add(e),this.updateSelectionUI(),this.renderMedia()}selectAll(e){e?this.filteredData.forEach(t=>this.selectedItems.add(t.id)):this.selectedItems.clear(),this.updateSelectionUI(),this.renderMedia()}clearSelection(){this.selectedItems.clear(),this.updateSelectionUI(),this.renderMedia()}updateSelectionUI(){const e=this.selectedItems.size,t=document.getElementById("deleteSelected"),o=document.getElementById("selectedInfo"),s=document.getElementById("selectedCount");e>0?(t.style.display="inline-block",o.style.display="block",s.textContent=e):(t.style.display="none",o.style.display="none")}updateMediaCount(){const e=document.getElementById("mediaCount");e&&(e.textContent=`${this.filteredData.length} items`)}showMediaDetails(e){var n,r;const t=this.mediaData.find(d=>d.id===e);if(!t){this.showToast("error","Media tidak ditemukan dalam daftar saat ini. Memuat ulang..."),this.loadMedia();return}document.getElementById("mediaTitle").value=t.name||"",document.getElementById("mediaAlt").value=((n=t.custom_properties)==null?void 0:n.alt)||"",document.getElementById("mediaDescription").value=((r=t.custom_properties)==null?void 0:r.description)||"",document.getElementById("mediaCollection").value=t.collection||"default",document.getElementById("mediaFileName").textContent=t.file_name||"",document.getElementById("mediaFileSize").textContent=t.size||"",document.getElementById("mediaFileType").textContent=t.mime_type||"",document.getElementById("mediaUploadDate").textContent=t.created_at||"";const o=document.getElementById("mediaPreview");o.innerHTML=this.getMediaPreview(t,"modal");const s=document.getElementById("editImage");t.mime_type&&t.mime_type.startsWith("image/")?s.style.display="inline-block":s.style.display="none",this.currentMediaId=e,this.currentEditItem=t;const i=document.getElementById("mediaDetailModal");new bootstrap.Modal(i).show()}async deleteSelected(){if(this.selectedItems.size!==0&&confirm(`Delete ${this.selectedItems.size} selected items?`))try{await m.post("/api/media-management/multiple/delete",{ids:Array.from(this.selectedItems)}),this.showToast("success","Selected items deleted successfully"),this.selectedItems.clear(),this.loadMedia()}catch{this.showToast("error","Failed to delete selected items")}}async deleteMedia(e){if(confirm("Delete this media file?"))try{const t=await m.delete(`/api/media-management/${e}`);t.data.status==="success"?(this.mediaData=this.mediaData.filter(o=>o.id!==e),this.allMediaData=this.allMediaData.filter(o=>o.id!==e),this.filteredData=this.filteredData.filter(o=>o.id!==e),this.selectedItems.delete(e),this.renderMedia(),this.updateMediaCount(),this.updateSelectionUI(),this.showToast("success",t.data.message||"Media deleted successfully"),await this.loadMedia()):this.showToast("error",t.data.message||"Failed to delete media")}catch(t){if(console.error("Delete media error:",t),t.response&&t.response.data){const o=t.response.data;o.message?this.showToast("error",o.message):o.status==="error"?this.showToast("error","Cannot delete this media"):this.showToast("error","Failed to delete media")}else this.showToast("error","Failed to delete media")}}async saveMediaDetails(){var t,o;if(!this.currentMediaId)return;const e={name:document.getElementById("mediaTitle").value,collection_name:document.getElementById("mediaCollection").value,custom_properties:{alt:document.getElementById("mediaAlt").value,description:document.getElementById("mediaDescription").value}};try{const s=await m.put(`/api/media-management/${this.currentMediaId}`,e);this.showToast("success","Media details updated successfully"),bootstrap.Modal.getInstance(document.getElementById("mediaDetailModal")).hide(),setTimeout(()=>{this.loadMedia()},300)}catch(s){if(console.error("Save error:",s),s.response&&s.response.status===404)this.showToast("error","Media tidak ditemukan. Mungkin sudah dihapus. Memuat ulang daftar media..."),bootstrap.Modal.getInstance(document.getElementById("mediaDetailModal")).hide(),setTimeout(()=>{this.loadMedia()},300);else{const i=((o=(t=s.response)==null?void 0:t.data)==null?void 0:o.message)||"Failed to update media details";this.showToast("error",i)}}}async deleteCurrentMedia(){this.currentMediaId&&(await this.deleteMedia(this.currentMediaId),bootstrap.Modal.getInstance(document.getElementById("mediaDetailModal")).hide())}startImageEdit(){if(!this.currentEditItem||!this.currentEditItem.mime_type.startsWith("image/"))return;const e=document.getElementById("mediaPreview");e&&(e.style.display="none"),this.imageCropper.startEdit(this.currentEditItem.url,this.currentEditItem)}cancelImageEdit(){this.imageCropper.cancel()}setCropMode(e){this.imageCropper&&this.imageCropper.setCropMode(e)}async applyImageEdit(){this.imageCropper&&await this.imageCropper.save()}showCreateFolderModal(){document.getElementById("folderName").value="",new bootstrap.Modal(document.getElementById("createFolderModal")).show()}async createFolder(){const e=document.getElementById("folderName").value.trim();if(!e){this.showToast("error","Please enter a folder name");return}try{const t=this.currentFolder?`${this.currentFolder}/${e}`:e;await m.post("/api/media/folders",{name:e,path:t,parent:this.currentFolder}),this.showToast("success","Folder created successfully"),bootstrap.Modal.getInstance(document.getElementById("createFolderModal")).hide(),this.loadMedia()}catch{this.showToast("error","Failed to create folder")}}navigateToFolder(e){this.currentFolder=e,localStorage.setItem("mediaCurrentFolder",e),this.updateBreadcrumb(),this.updateUploadCollection(),this.loadMedia()}updateBreadcrumb(){const e=document.getElementById("folderBreadcrumb");if(!e)return;let t='<li class="breadcrumb-item"><a href="#" data-folder="">üìÅ Root</a></li>';if(this.currentFolder){const o=this.currentFolder.split("/");let s="";o.forEach((i,a)=>{s+=(a>0?"/":"")+i,a===o.length-1?t+=`<li class="breadcrumb-item active">üìÅ ${i}</li>`:t+=`<li class="breadcrumb-item"><a href="#" data-folder="${s}">üìÅ ${i}</a></li>`})}e.innerHTML=t,e.querySelectorAll("a").forEach(o=>{o.addEventListener("click",s=>{s.preventDefault(),this.navigateToFolder(s.target.dataset.folder)})})}hideContextMenu(){this.contextMenu&&this.contextMenu.hide()}async copyToFolder(e){this.contextMenu&&await this.contextMenu.copyToFolder(e)}async moveToFolder(e){this.contextMenu&&await this.contextMenu.moveToFolder(e)}showToast(e,t){typeof window.showToast=="function"?window.showToast(t,e):alert(t)}}window.MediaLibrary=B;export{v as C,y as I,B as M,I as a,b,w as i,F as o};
