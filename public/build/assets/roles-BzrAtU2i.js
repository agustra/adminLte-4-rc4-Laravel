import{ModernTable as x}from"https://cdn.jsdelivr.net/npm/modern-table-js@1.0.6/core/ModernTable.js";import{D as A}from"./delete-QRht9yhg.js";import{f as I,c as P,a as F,b as M,d as E}from"./formatDate-Cz7pwXTf.js";import{h as y}from"./handlePermissionButtons-TMegtcb-.js";import{A as R}from"./ActionButton-4FF2Dtnd.js";import{f as _,D as L}from"./DateRangePicker-pIMxf9xW.js";import{s as i}from"./modalHandler-Bg5eHBCv.js";import{f as N}from"./fetchAxios-Cye8cR7v.js";import{I as $}from"./InitTomSelect-BFv3yElQ.js";import k from"./axiosClient-8LtfCK6A.js";import{i as g,f as H}from"./permissionsPopup-B0xN-n9d.js";import"./badgeUpdater-D1PKXa5-.js";import"./_commonjsHelpers-CqkleIqs.js";import"./preload-helper-BfFHrpNk.js";function h(t){let e;if(t&&t.target?e=t.target.querySelector("#permissions"):e=t,!e||e.tomselectInstance)return null;const o=e.dataset.selected?e.dataset.selected.split(",").filter(r=>r.trim()):[],n=new $(e,{urlGet:"/api/permissions/json?grouped=true",urlByIds:"/api/permissions/by-ids",urlStore:"/api/permissions",create:!0,createSingle:!0,modalId:"createTomselectModal",multiple:!0,createUrl:"/admin/permissions/create",valueField:"id",labelField:"name",searchField:["name"],preSelectedValues:o,grouped:!0,modalOptions:{fieldMapping:{permission:"name"},buttonId:"btnActionTomSelect"}});return n.ts.on("change",function(){u(n.ts)}),n}function u(t){let e;if(t&&t.target){const s=t.target.querySelector("#permissions");e=s==null?void 0:s.tomselectInstance}else e=t;const o=e?e.getValue():[],n=document.getElementById("permission-badges");if(n){if(n.innerHTML="",o.length===0){const r=document.createElement("small");r.className="text-muted",r.textContent="(0 permissions)",n.appendChild(r);return}k.get(`/api/permissions/by-ids?ids=${o.join(",")}`).then(r=>{const s=r.data.data||[];n.innerHTML="",s.forEach(T=>{const d=document.createElement("span");d.className="badge bg-success me-1 mb-1",d.textContent=T.name,n.appendChild(d)});const a=document.createElement("small");a.className="text-muted ms-2",a.textContent=`(${s.length} permissions)`,n.appendChild(a)}).catch(r=>{console.error("Error fetching permission names:",r),o.forEach(s=>{const a=document.createElement("span");a.className="badge bg-secondary me-1 mb-1",a.textContent=`Permission ${s}`,n.appendChild(a)})})}}const C={month:null,year:null,start_date:null,end_date:null};var p,f,b;const l={tableId:"#table-roles",urlWeb:`${((p=window.APP_CONFIG)==null?void 0:p.baseUrl)||""}/admin/roles/`,urlApi:`${((f=window.APP_CONFIG)==null?void 0:f.apiUrl)||"/api"}/roles`,deleteMultipleUrl:`${((b=window.APP_CONFIG)==null?void 0:b.apiUrl)||"/api"}/roles/multiple/delete`,tableName:"roles",exportColumns:["name","permissions"],createButtonText:"Add Roles",createButtonId:"btnTambah",bulkDeleteButtonId:"delete-selected-btn",dateRangeSelector:"#idFilterDateRange",dateRangeTextSelector:"#idFilterDateRange .date-range-text",actionButtonSelector:"#btnAction",formSelector:".FormAction",deleteButtonClass:".btn-delete",createButtonClass:".btnTambah",updateButtonClass:".buttonUpdate",showButtonClass:".buttonShow"};let m=!1,c={...C};const U=()=>m?Object.fromEntries(Object.entries(c).filter(([t,e])=>e!==null)):{},S=t=>{m=!0,c={...c,...t,date:null}},B=()=>{m=!1,c={...C}},v=F({buttonId:l.bulkDeleteButtonId,countSelector:".selected-count",onSelectionChange:(t,{count:e,hasSelection:o})=>{console.log(`ℹ️ Selection changed: ${e} roles selected`)}}),j=E({deleteUrl:l.deleteMultipleUrl,itemName:"roles",onSuccess:(t,e)=>{console.log("✅ Bulk delete success:",t.length,"roles deleted")},onError:t=>{console.error("❌ Bulk delete failed:",t)}});function W(){return I(new Date),{...P({url:l.urlApi,beforeSend:e=>Object.assign(e,U()),onSuccess:e=>{var n;const o=(n=e==null?void 0:e.meta)==null?void 0:n.permissions;o&&y(o)},onError:(e,o,n)=>{console.error("Roles API Error:",{error:e,status:o,message:n})}}),columns:[{data:"DT_RowIndex",title:"No",orderable:!1,searchable:!1},{data:"name",title:"Name",orderable:!0},{data:"permissions",title:"Permissions",orderable:!0,searchable:!0,render:(e,o,n)=>{let r=(n==null?void 0:n.permissions)??[];return typeof r=="string"&&(r=r.split(",").map(s=>s.trim()).filter(s=>s)),H(r,n,"role")}},{data:"actions",title:"Action",className:"text-center",orderable:!1,searchable:!1,render:(e,o,n)=>R(n)}],buttons:M({tableName:l.tableName,exportColumns:l.exportColumns,bulkDeleteHandler:j,bulkDeleteButtonId:l.bulkDeleteButtonId,includeCreateButton:!0,createButtonId:l.createButtonId,createButtonText:l.createButtonText,createHandler:()=>{i(`${l.urlWeb}create`,"create")}}),pageLength:10,lengthMenu:[5,10,25,50],order:[[0,"desc"]],ordering:!0,searching:!0,columnSearch:!0,paging:!0,select:!0,responsive:!0,theme:"auto",keyboard:!1,accessibility:!0,stateSave:!0,stateDuration:3600,onSelectionChange:v,onError:e=>console.error("❌ Table error:",e)}}function q(t,e,o){t||e?S({month:t||null,year:e||null}):B(),o.reload()}function G(t,e){if(t){S({start_date:t.start,end_date:t.end});const o=document.querySelector(l.dateRangeTextSelector);o&&(o.textContent=t.formatted)}else B();e.reload()}function w(){const t=W(),e=new x(l.tableId,{...t,initComplete:(o,n)=>{console.log("✅ Data loaded:",o.length,"records")}});return _((o,n)=>{q(o,n,e)}),new L(l.dateRangeSelector,{buttonText:"Filter Tanggal",onDateSelect:o=>{G(o,e)}}),e}function D(t){A({buttonSelector:l.deleteButtonClass,deleteUrl:l.urlApi+"/",tableSelector:l.tableId,onDeleteSuccess:()=>{t.reload(),t.clearSelection()}}),document.body.addEventListener("click",e=>{const o=e.target.closest(l.updateButtonClass),n=e.target.closest(l.showButtonClass),r=e.target.matches(l.actionButtonSelector);if(e.target.closest(l.createButtonClass))e.preventDefault(),i(`${l.urlWeb}create`,"create");else if(o){e.preventDefault();const a=`${l.urlWeb}${o.dataset.id}/edit`;i(a,"edit")}else if(n){e.preventDefault();const a=`${l.urlWeb}${n.dataset.id}`;i(a,"show")}else if(r){e.preventDefault();const a=document.querySelector(l.formSelector);a&&N({url:a.action,method:a.method,data:new FormData(a)},"simpan",()=>t.reload())}})}document.addEventListener("DOMContentLoaded",()=>{const t=w();if(D(t),g(),!window.rolesModalListenerAttached){const e=function(o){o.target.id==="modalAction"&&(console.log("Roles modal shown!"),h(o),u(o))};document.addEventListener("shown.bs.modal",e),window.rolesModalListenerAttached=!0,window.rolesModalHandler=e}});function re(){if(document.readyState!=="loading"){const t=w();if(D(t),g(),!window.rolesModalListenerAttached){const e=function(o){o.target.id==="modalAction"&&(console.log("Roles modal shown!"),h(o),u(o))};document.addEventListener("shown.bs.modal",e),window.rolesModalListenerAttached=!0,window.rolesModalHandler=e}}}export{re as default};
